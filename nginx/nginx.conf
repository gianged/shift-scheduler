events {
    worker_connections 1024;
}

http {
    upstream data_backend {
        server data-service:8080;
    }

    upstream scheduling_backend {
        server scheduling-service:8081;
    }

    server {
        listen 80;

        # Nginx own health check
        location = /headpat {
            access_log off;
            return 200 "ok";
            add_header Content-Type text/plain;
        }

        # Data service: staff endpoints
        location /api/v1/staff {
            proxy_pass http://data_backend;
            include /etc/nginx/proxy_params;
        }

        # Data service: group endpoints
        location /api/v1/groups {
            proxy_pass http://data_backend;
            include /etc/nginx/proxy_params;
        }

        # Data service: membership batch endpoint
        location /api/v1/memberships {
            proxy_pass http://data_backend;
            include /etc/nginx/proxy_params;
        }

        # Data service: health check
        location /data/headpat {
            rewrite ^/data/headpat /headpat break;
            proxy_pass http://data_backend;
            include /etc/nginx/proxy_params;
        }

        # Scheduling service: schedule endpoints
        location /api/v1/schedules {
            proxy_pass http://scheduling_backend;
            include /etc/nginx/proxy_params;
        }

        # Scheduling service: health check
        location /scheduling/headpat {
            rewrite ^/scheduling/headpat /headpat break;
            proxy_pass http://scheduling_backend;
            include /etc/nginx/proxy_params;
        }
    }
}
